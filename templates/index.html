<script>

let base64Image = null;
let firstMessage = true;

// ==========================
// Загрузка сохранённого чата
// ==========================
function loadChat(){
    const saved = localStorage.getItem("vision_chat_history");
    if(saved){
        document.getElementById("chat").innerHTML = saved;
    }
}

function saveChat(){
    const chatHTML = document.getElementById("chat").innerHTML;
    localStorage.setItem("vision_chat_history", chatHTML);
}

// Загружаем при старте
loadChat();


// === Загрузка изображения ===
document.getElementById("imageInput").addEventListener("change", function(e){
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(){

        base64Image = reader.result.split(",")[1];

        const imageDiv = document.createElement("div");
        imageDiv.className = "card image-card user";
        imageDiv.innerHTML = `<img src="${reader.result}">`;

        document.getElementById("chat").prepend(imageDiv);

        saveChat(); // сохраняем после добавления картинки
    };
    reader.readAsDataURL(file);
});


// Enter отправляет, Shift+Enter перенос строки
document.getElementById("prompt").addEventListener("keydown", function(e){
    if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendToAI();
    }
});


// === Отправка ===
async function sendToAI(){

    const promptInput = document.getElementById("prompt");
    const prompt = promptInput.value.trim();

    if(!prompt) return;

    promptInput.value = "";

    addMessage("Ты", prompt, "user");

    const thinkingDiv = document.createElement("div");
    thinkingDiv.className = "card thinking ai";
    thinkingDiv.innerHTML = "<b>AI:</b><br>AI is thinking...";
    document.getElementById("chat").prepend(thinkingDiv);

    try {

        const response = await fetch("/api/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                prompt: prompt,
                image: base64Image,
                first: firstMessage
            })
        });

        thinkingDiv.remove();

        if(!response.ok){
            addMessage("Ошибка", "Ошибка сервера", "ai");
            return;
        }

        const data = await response.json();

        if(data.error){
            addMessage("Ошибка", data.error, "ai");
            return;
        }

        addMessage("AI", data.answer, "ai");

        firstMessage = false;
        base64Image = null;

    } catch (error) {
        thinkingDiv.remove();
        addMessage("Ошибка", error.toString(), "ai");
    }
}


// === Добавление сообщения ===
function addMessage(author, text, type){
    const chat = document.getElementById("chat");

    const div = document.createElement("div");
    div.className = "card " + type;
    div.innerHTML = "<b>" + author + ":</b><br>" + text.replace(/\n/g, "<br>");

    chat.prepend(div);

    saveChat(); // сохраняем после каждого сообщения
}

</script>
